import streamlit as st
import pandas as pd
import plotly.graph_objs as go
import plotly.express as px
from plotly.subplots import make_subplots
import numpy as np

# Page config
st.set_page_config(
    page_title="Tra c·ª©u ƒëi·ªÉm thi 2025",
    page_icon="üéØ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Custom CSS for modern UI with League Spartan font
st.markdown("""
<style>
    /* Import Google Fonts - League Spartan */
    @import url('https://fonts.googleapis.com/css2?family=League+Spartan:wght@300;400;500;600;700;800&display=swap');
    
    /* Global Styles */
    .main {
        font-family: 'League Spartan', sans-serif;
    }
    
    /* Info Header Styles */
    .info-header {
        padding: 0.8rem 0;
        margin-bottom: 1rem;
        text-align: center;
        color: #666;
        font-size: 0.9rem;
        font-weight: 500;
    }
    
    .info-header a {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        transition: color 0.3s ease;
    }
    
    .info-header a:hover {
        color: #764ba2;
        text-decoration: underline;
    }
    
    .author-name {
        color: #667eea;
        font-weight: 700;
    }
    
    .company-name {
        color: #764ba2;
        font-weight: 700;
    }

    /* Header Styles */
    .main-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 2rem 1rem;
        border-radius: 20px;
        margin-bottom: 2rem;
        text-align: center;
        color: white;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }
    
    .main-title {
        font-size: 2.5rem;
        font-weight: 800;
        margin: 0;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .main-subtitle {
        font-size: 1.1rem;
        font-weight: 400;
        margin-top: 0.5rem;
        opacity: 0.9;
    }
    
    /* Card Styles */
    .metric-card {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        padding: 1.5rem;
        border-radius: 15px;
        margin: 1rem 0;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        border-left: 4px solid #667eea;
        transition: transform 0.3s ease;
    }
    
    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .metric-title {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.5rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .metric-value {
        font-size: 2rem;
        font-weight: 700;
        color: #333;
        margin: 0;
    }
    
    .metric-delta {
        font-size: 0.9rem;
        margin-top: 0.5rem;
    }
    
    /* Results Section */
    .results-container {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        margin: 2rem 0;
    }
    
    .region-header {
        display: flex;
        flex-direction: column;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }
    
    .region-title-row {
        display: flex;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .region-icon {
        font-size: 1.5rem;
        margin-right: 0.5rem;
        color: #333;
    }
    
    .region-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333 !important;
        margin: 0;
    }
    
    .region-subtext {
        font-size: 0.9rem;
        color: #666;
        font-style: italic;
        margin-left: 2rem;
        opacity: 0.8;
    }
    
    /* Input Styles */
    .stSelectbox > div > div > div {
        background: white;
        border-radius: 10px;
        font-family: 'League Spartan', sans-serif;
        color: #333 !important;
    }
    
    .stSelectbox > div > div > div > div {
        color: #333 !important;
    }
    
    .stSelectbox label {
        color: #333 !important;
    }
    
    .stNumberInput > div > div > input {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        transition: border-color 0.3s ease;
        font-family: 'League Spartan', sans-serif;
        color: #333 !important;
    }
    
    .stNumberInput > div > div > input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .stNumberInput label {
        color: #333 !important;
    }
    
    /* Hide number input +/- buttons */
    .stNumberInput > div > div > button {
        display: none !important;
    }
    
    /* Button Styles */
    .stButton > button {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0.5rem 2rem;
        font-weight: 600;
        font-size: 1rem;
        font-family: 'League Spartan', sans-serif;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .stButton > button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    /* Animation */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.6s ease-out;
    }
    
    /* Hide Streamlit elements */
    [data-testid="stToolbar"] {
        display: none !important;
    }
    
    .stAppDeployButton {
        display: none !important;
    }
    
    [data-testid="stDecoration"] {
        display: none !important;
    }
    
    [data-testid="stSidebarNav"] {
        display: none !important;
    }
    
    footer {
        display: none !important;
    }
    
    .viewerBadge_container__1QSob {
        display: none !important;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .main-title {
            font-size: 2rem;
        }
        
        .metric-card {
            margin: 0.5rem 0;
            padding: 1rem;
        }
        
        .results-container {
            padding: 1rem;
        }
        
        .region-title {
            color: #333 !important;
            font-size: 1.3rem;
        }
        
        .region-header {
            background: rgba(0,0,0,0.05);
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .region-subtext {
            margin-left: 0;
            font-size: 0.8rem;
        }
    }
</style>
""", unsafe_allow_html=True)

@st.cache_data
def load_data():
    """Load data for calculations (metrics, rankings)"""
    return pd.read_csv("lookup_2025_18_7.csv")

@st.cache_data
def load_histogram_data():
    """Load data specifically for histogram visualization"""
    return pd.read_csv("lookup_2025_18_7_histogram.csv")

@st.cache_data
def load_top_2024_data():
    """Load data for 2024 top percentage thresholds"""
    return pd.read_csv("lookup_2025_18_7_top_2024.csv")

def create_animated_metric_card(title, value, delta=None, icon="üìä"):
    delta_html = f'<div class="metric-delta" style="color: #28a745;">‚ñ≤ {delta}</div>' if delta else ""
    
    return f"""
    <div class="metric-card fade-in">
        <div class="metric-title">{icon} {title}</div>
        <div class="metric-value">{value}</div>
        {delta_html}
    </div>
    """

def get_2024_top_percentage(df_2024, khoi_input, region, diem_input):
    """T√¨m top % t∆∞∆°ng ·ª©ng v·ªõi ƒëi·ªÉm user n·∫øu thi nƒÉm 2024"""
    # Filter data cho view v√† kh·ªëi
    df_region_2024 = df_2024[df_2024['View'] == region].copy()
    
    if khoi_input not in df_region_2024.columns:
        return None
    
    # S·∫Øp x·∫øp theo Top % tƒÉng d·∫ßn
    df_region_2024 = df_region_2024.sort_values('Top %')
    
    # T√¨m top % m√† user ƒë·∫°t ƒë∆∞·ª£c (ƒëi·ªÉm user >= ƒëi·ªÉm ng∆∞·ª°ng)
    eligible_rows = df_region_2024[df_region_2024[khoi_input] <= diem_input]
    
    if eligible_rows.empty:
        # ƒêi·ªÉm qu√° th·∫•p, kh√¥ng l·ªçt top n√†o
        return {"top_percent": ">100", "threshold_score": None}
    
    # L·∫•y top % t·ªët nh·∫•t (nh·ªè nh·∫•t) m√† user ƒë·∫°t ƒë∆∞·ª£c
    best_top_percent = eligible_rows['Top %'].iloc[0]
    threshold_score = eligible_rows[khoi_input].iloc[0]
    
    return {
        "top_percent": f"{best_top_percent}%",
        "threshold_score": threshold_score
    }

def create_region_histogram(df_histogram, khoi_input, region, diem_input):
    """T·∫°o histogram cho t·ª´ng v√πng mi·ªÅn v·ªõi highlight cho ƒëi·ªÉm >= user score"""
    df_region = df_histogram[(df_histogram['khoi'] == khoi_input) & (df_histogram['view'] == region)].copy()
    df_region = df_region.sort_values('diem_moc')
    
    # Color mapping for each region
    region_colors = {
        'C·∫£ n∆∞·ªõc': '#667eea',
        'Mi·ªÅn B·∫Øc': '#f093fb', 
        'Mi·ªÅn Nam': '#4facfe'
    }
    
    region_color = region_colors.get(region, '#667eea')
    
    # Create color array based on user score
    colors = []
    opacities = []
    
    for score in df_region['diem_moc']:
        if score >= diem_input:
            # Keep original region color for scores >= user score
            colors.append(region_color)
            opacities.append(0.8)
        else:
            # Light gray for scores < user score
            colors.append('#d6d8db')  # Very light gray for scores < user score
            opacities.append(0.4)
    
    fig = go.Figure()
    
    # Add histogram bars with conditional coloring
    fig.add_trace(
        go.Bar(
            x=df_region['diem_moc'],
            y=df_region['count_exact'],
            name=f'S·ªë th√≠ sinh ƒë·∫°t ƒëi·ªÉm n√†y',
            marker=dict(
                color=colors,
                opacity=opacities,
                line=dict(width=0.5, color='white')
            ),
            hovertemplate=(
                '<b>ƒêi·ªÉm:</b> %{x}<br>' +
                '<b>S·ªë th√≠ sinh:</b> %{y:,.0f}<br>' +
                f'<b>V√πng:</b> {region}<br>' +
                '<b>Tr·∫°ng th√°i:</b> %{customdata}<br>' +
                '<extra></extra>'
            ),
            customdata=[
                'Cao h∆°n/b·∫±ng ƒëi·ªÉm c·ªßa b·∫°n' if score >= diem_input 
                else 'Th·∫•p h∆°n ƒëi·ªÉm c·ªßa b·∫°n' 
                for score in df_region['diem_moc']
            ]
        )
    )
    
    # Add user point with enhanced styling
    user_data = df_region[df_region['diem_moc'] == diem_input]
    if not user_data.empty:
        fig.add_trace(
            go.Scatter(
                x=[diem_input],
                y=[user_data['count_exact'].values[0]],
                mode='markers+text',
                marker=dict(
                    size=20, 
                    color='#dc3545',  # Red for user point
                    symbol='star',
                    line=dict(width=3, color='white')
                ),
                text=['ƒêI·ªÇM C·ª¶A B·∫†N'],
                textposition='top center',
                textfont=dict(
                    size=10,  # Smaller text for mobile
                    color='#dc3545',
                    family='League Spartan'
                ),
                name='ƒêi·ªÉm c·ªßa b·∫°n',
                hovertemplate=(
                    '<b>üéØ ƒêi·ªÉm c·ªßa b·∫°n:</b> %{x}<br>' +
                    '<b>üë• S·ªë th√≠ sinh c√πng ƒëi·ªÉm:</b> %{y:,.0f}<br>' +
                    '<extra></extra>'
                )
            )
        )
    
    # Add vertical line at user score for better visibility
    fig.add_vline(
        x=diem_input,
        line_dash="dash",
        line_color="#dc3545",
        line_width=2,
        opacity=0.7,
        annotation_text=f"ƒêi·ªÉm: {diem_input}",  # Shorter annotation for mobile
        annotation_position="top",
        annotation_font_size=10
    )
    
    # Mobile-optimized layout
    fig.update_layout(
        title=dict(
            text=f"Ph·ªï ƒëi·ªÉm thi - Kh·ªëi {khoi_input} ({region})",  # Removed subtitle
            font=dict(family="League Spartan", size=14)  # Smaller title for mobile
        ),
        xaxis_title="T·ªïng ƒëi·ªÉm",
        yaxis_title="S·ªë th√≠ sinh",
        height=350,  # Reduced height for mobile
        showlegend=False,  # Hide legend on mobile for cleaner look
        font=dict(family="League Spartan", size=10),  # Smaller font
        plot_bgcolor='white',
        paper_bgcolor='rgba(0,0,0,0)',
        hovermode='closest',
        margin=dict(t=60, b=40, l=40, r=20),  # Optimized margins for mobile
        xaxis=dict(
            showspikes=True,
            spikecolor="red",
            spikethickness=1,
            spikedash="dot"
        )
    )
    
    fig.update_xaxes(
        gridcolor='rgba(128,128,128,0.2)',
        title_font=dict(family="League Spartan", size=12),
        showgrid=False,
        zeroline=False,
        dtick=5,
        tick0=0,
        tickmode='linear'
    )
    fig.update_yaxes(
        gridcolor='rgba(128,128,128,0.2)',
        title_font=dict(family="League Spartan", size=12),
        showgrid=False,
        zeroline=False
    )
    
    return fig

def create_score_breakdown_table(df, khoi_input, region):
    """T·∫°o b·∫£ng th·ªëng k√™ ph√¢n b·ªï ƒëi·ªÉm theo c√°c m·ªëc quan tr·ªçng"""
    df_region = df[(df['khoi'] == khoi_input) & (df['view'] == region)].copy()
    df_region = df_region.sort_values('diem_moc', ascending=False)
    total = df_region['count_exact'].sum()
    
    # ƒê·ªãnh nghƒ©a c√°c m·ªëc ƒëi·ªÉm chi ti·∫øt
    score_thresholds = [29.0, 28.0, 27.0, 26.0, 25.0, 24.0, 23.0, 22.0, 21.0, 20.0, 19.0, 18.0, 17.0]
    
    breakdown_data = []
    
    # X·ª≠ l√Ω c√°c m·ªëc >= 17
    for threshold in score_thresholds:
        label = f"{int(threshold)}+"
        
        # T√¨m row c√≥ ƒëi·ªÉm ch√≠nh x√°c b·∫±ng threshold
        exact_row = df_region[df_region['diem_moc'] == threshold]
        
        if not exact_row.empty:
            # S·ª≠ d·ª•ng data c√≥ s·∫µn t·ª´ file
            student_count = exact_row['count_greater_equal'].values[0]
            percentage = exact_row['top_percent'].values[0]
        else:
            # N·∫øu kh√¥ng c√≥ ƒëi·ªÉm ch√≠nh x√°c, t√¨m ƒëi·ªÉm g·∫ßn nh·∫•t >= threshold
            filtered_df = df_region[df_region['diem_moc'] >= threshold]
            if not filtered_df.empty:
                closest_row = filtered_df.iloc[-1]  # L·∫•y ƒëi·ªÉm nh·ªè nh·∫•t >= threshold
                student_count = closest_row['count_greater_equal']
                percentage = closest_row['top_percent']
            else:
                student_count = 0
                percentage = 0.0
        
        breakdown_data.append({
            'T·ªïng ƒëi·ªÉm': label,
            'S·ªë th√≠ sinh': f"{student_count:,}",
            'Th·ª© h·∫°ng theo %': f"{percentage:.1f}%"
        })
    
    # X·ª≠ l√Ω m·ªëc <17
    filtered_df_below_17 = df_region[df_region['diem_moc'] < 17.0]
    student_count_below_17 = filtered_df_below_17['count_exact'].sum()
    percentage_below_17 = (student_count_below_17 / total * 100) if total > 0 else 0
    
    breakdown_data.append({
        'T·ªïng ƒëi·ªÉm': '<17',
        'S·ªë th√≠ sinh': f"{student_count_below_17:,}",
        'Th·ª© h·∫°ng theo %': f"{percentage_below_17:.1f}%"
    })
    
    # Th√™m d√≤ng Total
    breakdown_data.append({
        'T·ªïng ƒëi·ªÉm': 'Total',
        'S·ªë th√≠ sinh': f"{total:,}",
        'Th·ª© h·∫°ng theo %': '100.0%'
    })
    
    return pd.DataFrame(breakdown_data)

def display_score_breakdown_section(df, khoi_input, region, diem_input, user_result):
    """Hi·ªÉn th·ªã section th·ªëng k√™ ph√¢n b·ªï ƒëi·ªÉm"""
    
    st.markdown("""
    <div style="margin-top: 2rem;">
        <h4 style="color: #333; margin-bottom: 1rem;">üìä B·∫£ng so s√°nh chi ti·∫øt c√°c m·ªëc ƒëi·ªÉm:</h4>
    </div>
    """, unsafe_allow_html=True)
    
    # Ch·ªâ hi·ªÉn th·ªã note cho v√πng "C·∫£ n∆∞·ªõc" v·ªõi data th·ª±c t·∫ø c·ªßa user
    if region == "C·∫£ n∆∞·ªõc" and user_result:
        # T√≠nh to√°n dynamic values
        user_score = diem_input
        user_rank = user_result['rank']
        
        # L·∫•y s·ªë th√≠ sinh ·ªü m·ªëc ƒëi·ªÉm c·ªßa user
        df_region = df[(df['khoi'] == khoi_input) & (df['view'] == region)].copy()
        user_score_int = int(user_score) if user_score == int(user_score) else user_score
        
        # T√¨m m·ªëc ƒëi·ªÉm t∆∞∆°ng ·ª©ng trong b·∫£ng
        exact_row = df_region[df_region['diem_moc'] == user_score]
        if not exact_row.empty:
            students_at_threshold = exact_row['count_greater_equal'].values[0]
        else:
            # T√¨m m·ªëc g·∫ßn nh·∫•t
            threshold = int(user_score) if user_score >= int(user_score) else int(user_score) + 1
            threshold_row = df_region[df_region['diem_moc'] == threshold]
            students_at_threshold = threshold_row['count_greater_equal'].values[0] if not threshold_row.empty else 0
        
        # T√≠nh s·ªë th√≠ sinh c√πng ƒëi·ªÉm
        students_same_score = students_at_threshold - user_rank + 1
        
        st.markdown(f"""
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; border-left: 4px solid #17a2b8; margin-bottom: 1rem;">
            <p style="color: #666; font-size: 0.9rem; margin: 0;">
                <strong>üí° L∆∞u √Ω:</strong><br>
                ‚Ä¢ <strong>Th·ª© h·∫°ng tr√™n metrics</strong>: V·ªã tr√≠ c·ª• th·ªÉ c·ªßa b·∫°n trong danh s√°ch x·∫øp h·∫°ng<br>
                ‚Ä¢ <strong>S·ªë th√≠ sinh trong b·∫£ng</strong>: T·ªïng s·ªë th√≠ sinh ƒë·∫°t m·ªëc ƒëi·ªÉm ƒë√≥ tr·ªü l√™n (‚â•)<br>
                ‚Ä¢ <strong>V√≠ d·ª• v·ªõi ƒëi·ªÉm c·ªßa b·∫°n</strong>: B·∫°n c√≥ th·ª© h·∫°ng {user_rank:,} v√† m·ªëc {user_score_int}+ c√≥ {students_at_threshold:,} th√≠ sinh, 
                nghƒ©a l√† c√≥ {students_same_score:,} th√≠ sinh c√πng ƒëi·ªÉm {user_score} v·ªõi b·∫°n
            </p>
        </div>
        """, unsafe_allow_html=True)
    
    # T·∫°o b·∫£ng breakdown
    breakdown_df = create_score_breakdown_table(df, khoi_input, region)
    
    # Custom styling cho b·∫£ng v·ªõi d√≤ng Total ƒë∆∞·ª£c highlight
    def highlight_total_row(row):
        if row['T·ªïng ƒëi·ªÉm'] == 'Total':
            return ['background-color: #667eea; color: white; font-weight: bold; border: 1px solid #5a6fd8; padding: 10px; text-align: center; font-family: League Spartan;'] * len(row)
        else:
            return ['background-color: #f8f9fa; border: 1px solid #dee2e6; padding: 8px; text-align: center; font-family: League Spartan;'] * len(row)
    
    styled_df = breakdown_df.style.apply(highlight_total_row, axis=1).set_table_styles([
        {
            'selector': 'thead th',
            'props': [
                ('background-color', '#667eea'),
                ('color', 'white'),
                ('font-weight', 'bold'),
                ('text-align', 'center'),
                ('padding', '12px'),
                ('font-family', 'League Spartan'),
                ('border', '1px solid #5a6fd8')
            ]
        },
        {
            'selector': 'table',
            'props': [
                ('border-collapse', 'collapse'),
                ('margin', '0 auto'),
                ('border-radius', '8px'),
                ('overflow', 'hidden'),
                ('box-shadow', '0 4px 6px rgba(0, 0, 0, 0.1)'),
                ('width', '100%')
            ]
        }
    ]).hide(axis="index")
    
    # Hi·ªÉn th·ªã b·∫£ng
    st.dataframe(
        styled_df,
        use_container_width=True,
        hide_index=True,
        column_config={
            "T·ªïng ƒëi·ªÉm": st.column_config.TextColumn(
                "T·ªïng ƒëi·ªÉm",
                width="medium",
            ),
            "S·ªë th√≠ sinh": st.column_config.TextColumn(
                "S·ªë th√≠ sinh",
                width="medium",
            ),
            "Th·ª© h·∫°ng theo %": st.column_config.TextColumn(
                "Th·ª© h·∫°ng theo %",
                width="medium",
            )
        }
    )
    
    # Ch·ªâ hi·ªÉn th·ªã note cu·ªëi cho v√πng "C·∫£ n∆∞·ªõc" v·ªõi ƒëi·ªÉm th·ª±c t·∫ø c·ªßa user
    if region == "C·∫£ n∆∞·ªõc":
        user_score_int = int(diem_input) if diem_input == int(diem_input) else int(diem_input)
        st.markdown(f"""
        <div style="margin-top: 1rem; padding: 0.8rem; background: #e8f4f8; border-radius: 6px; border-left: 3px solid #17a2b8;">
            <p style="color: #31708f; font-size: 0.85rem; margin: 0; font-style: italic;">
                <strong>üîç C√°ch ƒë·ªçc b·∫£ng:</strong> M·ªëc "{user_score_int}+" c√≥ nghƒ©a l√† s·ªë th√≠ sinh ƒë·∫°t t·ª´ {user_score_int}.0 ƒëi·ªÉm tr·ªü l√™n. 
                N·∫øu b·∫°n c√≥ {diem_input} ƒëi·ªÉm, b·∫°n s·∫Ω n·∫±m trong nh√≥m n√†y c√πng v·ªõi nh·ªØng ng∆∞·ªùi c√≥ ƒëi·ªÉm cao h∆°n.
            </p>
        </div>
        """, unsafe_allow_html=True)

def get_region_subtext(region):
    """Get descriptive subtext for each region"""
    subtexts = {
        'C·∫£ n∆∞·ªõc': 'To√†n b·ªô c√°c t·ªânh th√†nh tr√™n c·∫£ n∆∞·ªõc',
        'Mi·ªÅn B·∫Øc': 'C√°c t·ªânh th√†nh t·ª´ Hu·∫ø tr·ªü ra B·∫Øc', 
        'Mi·ªÅn Nam': 'C√°c t·ªânh th√†nh t·ª´ ƒê√† N·∫µng tr·ªü v√¥ Nam'
    }
    return subtexts.get(region, '')

# Load data
df = load_data()  # For calculations
df_histogram = load_histogram_data()  # For histogram visualization
df_2024 = load_top_2024_data()  # For 2024 comparison

# Mobile sidebar solution using session state
if 'sidebar_open' not in st.session_state:
    st.session_state.sidebar_open = True

# Add custom mobile sidebar toggle
col_toggle, col_spacer = st.columns([1, 10])
with col_toggle:
    if st.button("‚ò∞", key="mobile_toggle", help="M·ªü/ƒë√≥ng menu"):
        st.session_state.sidebar_open = not st.session_state.sidebar_open

# Info Header
st.markdown("""
<div class="info-header">
    üìä Data ƒë∆∞·ª£c x·ª≠ l√Ω v√† ph√¢n t√≠ch b·ªüi <span class="author-name">Hieu Nguyen</span> - Founder of 
    <a href="https://madzynguyen.com/product/master-analytical-thinking-data-analysis-with-power-bi/?utm_source=web&utm_medium=maz&utm_campaign=web_diemthi_link&utm_id=web_diemthi&utm_content=web_diemthi" target="_blank" class="company-name">MazHocData</a> | 
    <a href="https://www.linkedin.com/in/ntrunghieu/" target="_blank">üíº LinkedIn</a>
</div>
""", unsafe_allow_html=True)

# Header
st.markdown("""
<div class="main-header">
    <h1 class="main-title">üéØ Tra c·ª©u th·ª© h·∫°ng ƒëi·ªÉm thi 2025</h1>
    <p class="main-subtitle">Kh√°m ph√° v·ªã tr√≠ c·ªßa b·∫°n trong b·∫£ng x·∫øp h·∫°ng to√†n qu·ªëc v·ªõi giao di·ªán hi·ªán ƒë·∫°i</p>
</div>
""", unsafe_allow_html=True)

# Sidebar (conditional display for mobile)
if st.session_state.sidebar_open or st.session_state.get('force_sidebar', False):
    with st.sidebar:
        st.markdown("### üìö Thi·∫øt l·∫≠p tra c·ª©u")
        
        st.markdown("---")
        
        # Inputs
        khoi_input = st.selectbox(
            "üìö Ch·ªçn kh·ªëi thi",
            sorted(df['khoi'].unique()),
            help="Ch·ªçn kh·ªëi thi b·∫°n mu·ªën tra c·ª©u"
        )
        
        diem_input = st.number_input(
            "üéØ Nh·∫≠p t·ªïng ƒëi·ªÉm",
            min_value=0.0,
            max_value=30.0,
            value=21.0,
            step=0.05,
            help="Nh·∫≠p t·ªïng ƒëi·ªÉm c·ªßa b·∫°n (0-30)"
        )
        
        lookup_button = st.button("üîç Tra c·ª©u ngay", use_container_width=True)
        
        # Th√¥ng tin b·ªï sung
        st.markdown("---")
        
        # Tips section
        st.markdown("### üí° G·ª£i √Ω")
        st.markdown("""
        <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                    padding: 1rem; border-radius: 10px; margin: 0.5rem 0;">
            <p style="margin: 0; font-size: 0.85rem; color: #495057;">
                <strong>üéØ ƒêi·ªÉm cao:</strong> ‚â• 24 ƒëi·ªÉm<br>
                <strong>üìà ƒêi·ªÉm kh√°:</strong> 18-24 ƒëi·ªÉm<br>
                <strong>‚öñÔ∏è ƒêi·ªÉm trung b√¨nh:</strong> < 18 ƒëi·ªÉm
            </p>
        </div>
        """, unsafe_allow_html=True)
        
        # Help section
        st.markdown("### ‚ùì Tr·ª£ gi√∫p")
        with st.expander("üìñ C√°ch s·ª≠ d·ª•ng"):
            st.markdown("""
            1. **Ch·ªçn kh·ªëi thi** c·ªßa b·∫°n
            2. **Nh·∫≠p ƒëi·ªÉm t·ªïng** (3 m√¥n c·ªông l·∫°i)
            3. **Nh·∫•n tra c·ª©u** ƒë·ªÉ xem k·∫øt qu·∫£
            4. **Xem bi·ªÉu ƒë·ªì** v√† b·∫£ng th·ªëng k√™ chi ti·∫øt
            """)
        
        with st.expander("ü§î C√¢u h·ªèi th∆∞·ªùng g·∫∑p"):
            st.markdown("""
            **Q: ƒêi·ªÉm t√¥i nh·∫≠p c√≥ ch√≠nh x√°c kh√¥ng?**  
            A: ƒê·∫£m b·∫£o c·ªông ƒë√∫ng t·ªïng 3 m√¥n thi
            
            **Q: Th·ª© h·∫°ng c√≥ √Ω nghƒ©a g√¨?**  
            A: V·ªã tr√≠ c·ªßa b·∫°n so v·ªõi t·∫•t c·∫£ th√≠ sinh c√πng kh·ªëi
            
            **Q: D·ªØ li·ªáu t·ª´ ngu·ªìn n√†o?**  
            A: T·ª´ k·∫øt qu·∫£ thi ch√≠nh th·ª©c nƒÉm 2025
            """)
        
        # Contact info
        st.markdown("---")
        st.markdown("""
        <div style="text-align: center; padding: 0.5rem;">
            <p style="margin: 0; font-size: 0.8rem; color: #6c757d;">
                üí¨ C·∫ßn h·ªó tr·ª£? Li√™n h·ªá qua<br>
                <a href="https://www.facebook.com/madzyandlucas" target="_blank" 
                   style="color: #667eea; text-decoration: none;">
                   Facebook
                </a> 
                ho·∫∑c 
                <a href="https://madzynguyen.com" target="_blank" 
                   style="color: #667eea; text-decoration: none;">
                   Website
                </a>
            </p>
        </div>
        """, unsafe_allow_html=True)
        
        # DON'T close sidebar after search - keep it open for multiple searches
        # This fixes the bug where users can't change inputs after first search
else:
    # Create hidden inputs to maintain state
    khoi_input = st.session_state.get('khoi_input', sorted(df['khoi'].unique())[0])
    diem_input = st.session_state.get('diem_input', 21.0)
    lookup_button = st.session_state.get('lookup_button', False)

# Store input values in session state
st.session_state.khoi_input = khoi_input
st.session_state.diem_input = diem_input

# Main content
if lookup_button:
    
    def format_region_result(df, diem_input, region):
        df_region = df[(df['khoi'] == khoi_input) & (df['view'] == region)].copy()
        df_region = df_region.sort_values('diem_moc')
        df_region['cumsum'] = df_region['count_exact'].cumsum()
        total = df_region['count_exact'].sum()

        user_row = df_region[df_region['diem_moc'] == diem_input]
        if user_row.empty:
            return None

        surpassed = int(user_row['cumsum'].values[0])
        percentile = 100 * surpassed / total
        rank = int(total - surpassed + 1)

        return {
            'top_percent': 100 - percentile,
            'higher_than_count': surpassed,
            'rank': rank,
            'total': int(total),
            'percentile': percentile
        }
    
    # Only one tab now - K·∫øt qu·∫£ chi ti·∫øt
    st.markdown('<div class="fade-in">', unsafe_allow_html=True)
    
    # Quick overview metrics
    col1, col2, col3, col4 = st.columns(4)
    
    regions = ['C·∫£ n∆∞·ªõc', 'Mi·ªÅn B·∫Øc', 'Mi·ªÅn Nam']
    region_icons = ['üåç', '‚õ∞Ô∏è', 'üèñÔ∏è']
    
    results = {}
    for region in regions:
        results[region] = format_region_result(df, diem_input, region)
    
    # Display metrics
    for i, (region, icon) in enumerate(zip(regions, region_icons)):
        result = results[region]
        if result:
            # Get total students for this region
            df_region = df[(df['khoi'] == khoi_input) & (df['view'] == region)]
            total_students = df_region['count_exact'].sum()
            
            with [col1, col2, col3][i]:
                st.markdown(create_animated_metric_card(
                    f"Top % - {region}",
                    f"{result['top_percent']:.1f}%",
                    delta=f"T·ªïng: {total_students:,} th√≠ sinh",
                    icon=icon
                ), unsafe_allow_html=True)
    
    with col4:
        # Get ranking compared to entire country
        country_result = results['C·∫£ n∆∞·ªõc']
        ranking_info = f"#{country_result['rank']:,} / {country_result['total']:,}" if country_result else "N/A"
        
        st.markdown(create_animated_metric_card(
            "ƒêi·ªÉm c·ªßa b·∫°n",
            f"{diem_input:.2f}",
            delta=f"X·∫øp h·∫°ng: {ranking_info}",
            icon="üéØ"
        ), unsafe_allow_html=True)
    
    # 2024 Comparison Section
    st.markdown("### üìÖ So s√°nh v·ªõi nƒÉm 2024")
    st.markdown("""
    <div style="background: #f8f9fa; padding: 1rem; border-radius: 10px; margin: 1rem 0; border-left: 4px solid #ffc107;">
        <p style="margin: 0; color: #856404; font-size: 0.9rem;">
            <strong>üí° Th√¥ng tin:</strong> N·∫øu ƒëi·ªÉm s·ªë n√†y thi v√†o nƒÉm 2024, b·∫°n s·∫Ω ƒë·∫°t top % nh∆∞ sau:
        </p>
    </div>
    """, unsafe_allow_html=True)
    
    col1_2024, col2_2024, col3_2024 = st.columns(3)
    
    for i, (region, icon) in enumerate(zip(regions, region_icons)):
        comparison_2024 = get_2024_top_percentage(df_2024, khoi_input, region, diem_input)
        
        with [col1_2024, col2_2024, col3_2024][i]:
            if comparison_2024:
                if comparison_2024["top_percent"] == ">100":
                    st.markdown(create_animated_metric_card(
                        f"2024 - {region}",
                        "Ngo√†i top 100%",
                        delta="ƒêi·ªÉm ch∆∞a ƒë·ªß",
                        icon="üìâ"
                    ), unsafe_allow_html=True)
                else:
                    # So s√°nh v·ªõi k·∫øt qu·∫£ 2025
                    current_result = results[region]
                    if current_result:
                        current_top = current_result['top_percent']
                        comparison_2024_num = float(comparison_2024["top_percent"].replace('%', ''))
                        
                        if comparison_2024_num < current_top:
                            trend = f"T·ªët h∆°n {current_top - comparison_2024_num:.1f}%"
                            trend_color = "#28a745"
                        elif comparison_2024_num > current_top:
                            trend = f"K√©m h∆°n {comparison_2024_num - current_top:.1f}%"
                            trend_color = "#dc3545"
                        else:
                            trend = "T∆∞∆°ng ƒë∆∞∆°ng"
                            trend_color = "#ffc107"
                    else:
                        trend = ""
                        trend_color = "#666"
                    
                    st.markdown(f"""
                    <div class="metric-card fade-in">
                        <div class="metric-title">{icon} 2024 - {region}</div>
                        <div class="metric-value">Top {comparison_2024["top_percent"]}</div>
                        <div class="metric-delta" style="color: {trend_color};">
                            {trend}
                        </div>
                    </div>
                    """, unsafe_allow_html=True)
    
    # Detailed results for each region with histogram
    for region, icon in zip(regions, region_icons):
        result = results[region]
        if result:
            st.markdown(f"""
            <div class="results-container fade-in">
                <div class="region-header">
                    <div class="region-title-row">
                        <span class="region-icon">{icon}</span>
                        <h2 class="region-title">{region}</h2>
                    </div>
                    <div class="region-subtext">{get_region_subtext(region)}</div>
                </div>
            """, unsafe_allow_html=True)
            
            # Desktop: side by side layout
            col_metrics, col_chart = st.columns([1, 2])
            
            with col_metrics:
                st.metric(
                    "üèÜ X·∫øp h·∫°ng top",
                    f"{result['top_percent']:.2f}%",
                    delta=f"Cao h∆°n {result['higher_than_count']:,} th√≠ sinh"
                )
                
                st.metric(
                    "üìä Th·ª© h·∫°ng",
                    f"{result['rank']:,}",
                    delta=f"Tr√™n t·ªïng {result['total']:,} th√≠ sinh"
                )
                
                st.metric(
                    "üìà Ph√¢n v·ªã", 
                    f"{result['percentile']:.1f}",
                    delta="percentile"
                )
            
            with col_chart:
                fig_histogram = create_region_histogram(df_histogram, khoi_input, region, diem_input)
                st.plotly_chart(fig_histogram, use_container_width=True)
            
            # Th√™m b·∫£ng th·ªëng k√™ ph√¢n b·ªï ƒëi·ªÉm v·ªõi parameters ƒë·∫ßy ƒë·ªß
            display_score_breakdown_section(df, khoi_input, region, diem_input, result)
            
            st.markdown("</div>", unsafe_allow_html=True)
    
    st.markdown('</div>', unsafe_allow_html=True)

else:
    # Welcome screen
    st.markdown("""
    <div class="results-container fade-in" style="text-align: center; padding: 3rem;">
        <h2>üöÄ Ch√†o m·ª´ng ƒë·∫øn v·ªõi h·ªá th·ªëng tra c·ª©u ƒëi·ªÉm thi hi·ªán ƒë·∫°i!</h2>
        <p style="font-size: 1.1rem; color: #666; margin: 2rem 0;">
            Nh·∫≠p th√¥ng tin c·ªßa b·∫°n ·ªü sidebar b√™n tr√°i v√† nh·∫•n n√∫t <strong>"Tra c·ª©u ngay"</strong> 
            ƒë·ªÉ kh√°m ph√° v·ªã tr√≠ c·ªßa m√¨nh trong b·∫£ng x·∫øp h·∫°ng to√†n qu·ªëc.
        </p>
        <div style="display: flex; justify-content: center; gap: 2rem; margin-top: 2rem;">
            <div style="text-align: center;">
                <div style="font-size: 3rem;">üìä</div>
                <h4>Ph√¢n t√≠ch chi ti·∫øt</h4>
                <p>Xem th·ª© h·∫°ng v√† ph√¢n v·ªã c·ªßa b·∫°n v·ªõi bi·ªÉu ƒë·ªì t∆∞∆°ng t√°c</p>
            </div>
        </div>
    </div>
    """, unsafe_allow_html=True)

# Footer
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #666; padding: 1rem;">
    <p>üéØ <strong>Tra c·ª©u ƒëi·ªÉm thi 2025</strong> | ƒê∆∞·ª£c x√¢y d·ª±ng v·ªõi ‚ù§Ô∏è HieuNguyen</p>
    <p style="font-size: 0.9rem;">üí° D·ªØ li·ªáu ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª´ k·∫øt qu·∫£ thi ch√≠nh th·ª©c</p>
</div>
""", unsafe_allow_html=True)
